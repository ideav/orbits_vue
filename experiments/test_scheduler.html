<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест планировщика задач</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .content {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #333;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .error {
            background-color: #ffebee;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #c62828;
        }
    </style>
</head>
<body>
    <h1>Тест планировщика задач проекта</h1>

    <div class="info">
        <strong>Информация:</strong>
        <p>Этот тестовый файл использует встроенные данные из файла "Результаты запросов по API.txt"</p>
        <p>Откройте консоль браузера (F12), чтобы увидеть детальные логи работы планировщика</p>
    </div>

    <div class="content">
        <p>Загрузка...</p>
    </div>

    <script>
        // Эмулируем глобальные переменные
        window.db = 'orbits';
        window.xsrf = 'test_xsrf_token';

        // Встроенные данные для тестирования
        const mockData = {
            2681: [{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2327","Задача проекта":"Проверка документации","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"115:849(-),2673:(3-)","Норматив задачи":"","Предыдущая Задача":"","Операция":"Проверка доков на полноту и качество","Операция -> Начать":null,"ОперацияID":"2347","Норматив операции":"120","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2327","Задача проекта":"Проверка документации","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"115:849(-),2673:(3-)","Норматив задачи":"","Предыдущая Задача":"","Операция":"Обработка документации от заказчика","Операция -> Начать":null,"ОперацияID":"2382","Норматив операции":"240","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2329","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"2673:(3-),115:849(-)","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Получение реперных точек","Операция -> Начать":null,"ОперацияID":"2330","Норматив операции":"180","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2329","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"115:849(-),2673:(3-)","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Разметка витража на проекте","Операция -> Начать":null,"ОперацияID":"2384","Норматив операции":"240","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2329","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"115:849(-),2673:(3-)","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Разработка последовательности сборки","Операция -> Начать":null,"ОперацияID":"2386","Норматив операции":"180","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2329","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"115:849(-),2673:(3-)","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Разгрузка стоек и ригелей","Операция -> Начать":null,"ОперацияID":"2388","Норматив операции":"12","Кол-во":"","Исполнителей":"2","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2390","Задача проекта":"Подготовка к монтажу (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Разгрузка стеклопакетов","Операция -> Начать":null,"ОперацияID":"2395","Норматив операции":"15","Кол-во":"","Исполнителей":"2","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2334","Задача проекта":"Монтаж стеклопакетов","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Сборка каркаса","Операция -> Начать":null,"ОперацияID":"2391","Норматив операции":"40","Кол-во":"","Исполнителей":"2","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2334","Задача проекта":"Монтаж стеклопакетов","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Установка каркаса","Операция -> Начать":null,"ОперацияID":"2393","Норматив операции":"30","Кол-во":"","Исполнителей":"2","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2334","Задача проекта":"Монтаж стеклопакетов","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Монтаж стеклопакетов","Операция -> Начать":null,"ОперацияID":"2397","Норматив операции":"30","Кол-во":"","Исполнителей":"2","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2326","Проект":"Шаблон. Установка витражей СПК (ОПЕРАЦИИ)","Старт":"","Задача проектаID":"2344","Задача проекта":"Сдача выполненных работ","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"1015:%(-)","Норматив задачи":"300","Предыдущая Задача":"Монтаж стеклопакетов","Операция":"","Операция -> Начать":null,"ОперацияID":"","Норматив операции":"","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"","Статус проекта":"","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2615","Задача проекта":"Проверка документации","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Проверка доков на полноту и качество","Операция -> Начать":null,"ОперацияID":"2632","Норматив операции":"","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2615","Задача проекта":"Проверка документации","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Обработка документации от заказчика","Операция -> Начать":null,"ОперацияID":"2633","Норматив операции":"","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2616","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Получение реперных точек","Операция -> Начать":null,"ОперацияID":"2617","Норматив операции":"","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2616","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Разметка витража на проекте","Операция -> Начать":null,"ОперацияID":"2619","Норматив операции":"","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2616","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Разработка последовательности сборки","Операция -> Начать":null,"ОперацияID":"2620","Норматив операции":"","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2616","Задача проекта":"Подготовка (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"Проверка документации","Операция":"Разгрузка стоек и ригелей","Операция -> Начать":null,"ОперацияID":"2621","Норматив операции":"","Кол-во":"30","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2630","Задача проекта":"Подготовка к монтажу (предоперации)","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Разгрузка стеклопакетов","Операция -> Начать":null,"ОперацияID":"2631","Норматив операции":"","Кол-во":"30","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2624","Задача проекта":"Монтаж стеклопакетов","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Сборка каркаса","Операция -> Начать":null,"ОперацияID":"2625","Норматив операции":"","Кол-во":"30","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2624","Задача проекта":"Монтаж стеклопакетов","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Установка каркаса","Операция -> Начать":null,"ОперацияID":"2626","Норматив операции":"","Кол-во":"30","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2624","Задача проекта":"Монтаж стеклопакетов","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"","Предыдущая Задача":"","Операция":"Монтаж стеклопакетов","Операция -> Начать":null,"ОперацияID":"2627","Норматив операции":"","Кол-во":"30","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""},{"ПроектID":"2614","Проект":"Установка витражей СПК (ОПЕРАЦИИ)","Старт":"20.11.2025","Задача проектаID":"2628","Задача проекта":"Сдача выполненных работ","К-во":"","Начать":"","Исполнитель Задачи":"","Параметры задачи":"","Норматив задачи":"90","Предыдущая Задача":"Монтаж стеклопакетов","Операция":"","Операция -> Начать":null,"ОперацияID":"","Норматив операции":"","Кол-во":"","Исполнителей":"","Ед.изм.":"","Шаблон Проекта (Проект)":"2326","Статус проекта":"В работе","Захватка":"","Координаты":""}],
            3283: [{"Настройка проекта":"Вторая операция стажера, время, %","Код":"2nd_op_tolerance","Значение":"15","MU":"minutes"},{"Настройка проекта":"Конец дня","Код":"day_end","Значение":"18","MU":"hours"},{"Настройка проекта":"Начало дня","Код":"day_start","Значение":"9","MU":"hours"},{"Настройка проекта":"Обед","Код":"lunch_start","Значение":"13","MU":"hours"},{"Настройка проекта":"Первая операция стажера, время, %","Код":"1st_op_tolerance","Значение":"30","MU":"minutes"},{"Настройка проекта":"Третья операция стажера, время, %","Код":"3rd_op_tolerance","Значение":"0","MU":"minutes"}],
            3248: [{"ПараметрID":"1015","Параметр":"Задача проекта -> Подтверждено заказчиком"},{"ПараметрID":"115","Параметр":"Пользователь -> Роль"},{"ПараметрID":"2673","Параметр":"Квалификация -> Уровень"},{"ПараметрID":"728","Параметр":"Пользователь -> Квалификация"},{"ПараметрID":"740","Параметр":"Операция -> Дата подтверждения"}],
            2777: [{"Пользователь":"barabashinkv","ПользовательID":"854","Квалификация -> Уровень":null,"Занятое время":"","Роль":"849"},{"Пользователь":"eng","ПользовательID":"1051","Квалификация -> Уровень":null,"Занятое время":"","Роль":"849"},{"Пользователь":"glushkovam","ПользовательID":"846","Квалификация -> Уровень":null,"Занятое время":"20251121:9-12,20251122:8-11","Роль":"849"},{"Пользователь":"rezhepa","ПользовательID":"1178","Квалификация -> Уровень":null,"Занятое время":"","Роль":"849"},{"Пользователь":"vova","ПользовательID":"1183","Квалификация -> Уровень":null,"Занятое время":"","Роль":"849"},{"Пользователь":"Ян","ПользовательID":"1416","Квалификация -> Уровень":null,"Занятое время":"","Роль":"849"}]
        };

        // Переопределяем fetch для использования встроенных данных
        const originalFetch = window.fetch;
        window.fetch = async function(url, options) {
            console.log('[Mock] Fetch called:', url, options);

            // Проверяем, это GET-запрос к отчетам
            if (!options || !options.method || options.method === 'GET') {
                for (const [reportId, data] of Object.entries(mockData)) {
                    if (url.includes(`/report/${reportId}?`)) {
                        console.log(`[Mock] Returning mock data for report ${reportId}`);
                        return {
                            ok: true,
                            status: 200,
                            json: async () => data
                        };
                    }
                }
            }

            // Для POST-запросов (сохранение данных) просто возвращаем успех
            if (options && options.method === 'POST') {
                console.log('[Mock] POST request intercepted, returning success');
                return {
                    ok: true,
                    status: 200,
                    json: async () => ({ success: true })
                };
            }

            // Для остальных запросов используем оригинальный fetch
            return originalFetch(url, options);
        };
    </script>

    <!-- Загружаем основной скрипт планировщика -->
    <script src="../scheduler.js"></script>
</body>
</html>
