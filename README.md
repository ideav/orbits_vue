# Планировщик задач и операций проекта

Автоматический планировщик для составления графика выполнения задач и операций проекта с назначением исполнителей.

## Описание

Данный скрипт выполняет следующие функции:

1. **Загрузка данных проекта** - получение информации о проекте, шаблоне, настройках и доступных исполнителях через API
2. **Расчет нормативов** - автоматический расчет нормативов для задач и операций на основе шаблона и количества
3. **Планирование времени** - определение времени начала и окончания задач с учетом:
   - Рабочего дня (по умолчанию 9:00-18:00)
   - Обеденного перерыва (по умолчанию 13:00-14:00)
   - Последовательности выполнения задач
   - Ограничения на разделение коротких задач (≤4 часов) между днями
4. **Назначение исполнителей** - подбор исполнителей на основе:
   - Соответствия параметрам задачи (роль, квалификация)
   - Доступности исполнителя
   - Требуемого количества исполнителей
5. **Визуализация результатов** - отображение графика в виде HTML-таблицы

## Использование

### На реальной странице integram.io

Скопируйте содержимое файла `scheduler.js` и вставьте в консоль браузера (F12) на странице проекта в системе integram.io.

Скрипт автоматически:
- Определит текущую базу данных (`window.db`)
- Получит XSRF-токен (`window.xsrf`)
- Загрузит данные через API
- Выполнит планирование
- Отобразит результат в элементе `.content`

### Тестирование локально

Откройте файл `experiments/test_scheduler.html` в браузере. Этот файл использует встроенные тестовые данные из файла "Результаты запросов по API.txt".

## Структура проекта

```
.
├── scheduler.js                    # Основной скрипт планировщика
├── experiments/
│   └── test_scheduler.html        # Тестовый файл с встроенными данными
├── Результаты запросов по API.txt # Примеры данных API для отладки
└── README.md                       # Данный файл
```

## API Endpoints

Скрипт использует следующие endpoints:

- `GET /report/2681?JSON_KV` - данные проекта и шаблона
- `GET /report/3283?JSON_KV` - настройки рабочего дня
- `GET /report/3248?JSON_KV` - справочник параметров
- `GET /report/2777?JSON_KV` - список доступных исполнителей
- `POST /_m_set/{ID}?JSON=1` - сохранение нормативов и времени начала

## Параметры настройки

Скрипт поддерживает следующие параметры, получаемые из API:

- `day_start` - начало рабочего дня (часы)
- `day_end` - конец рабочего дня (часы)
- `lunch_start` - начало обеда (часы)

## Логирование

Для включения детального логирования установите флаг `DEBUG = true` в начале скрипта. Логи выводятся в консоль браузера с префиксом `[Scheduler]`.

## Формат данных

### Параметры задач/операций

Формат: `ПараметрID:Значение(Диапазон)`

Примеры:
- `115:849(-)` - требуется роль 849
- `2673:(3-)` - квалификация уровня 3 и выше
- `1015:%(-)` - значение должно быть заполнено

### Занятое время исполнителей

Формат: `YYYYMMDD:HH-HH,YYYYMMDD:HH-HH`

Пример: `20251121:9-12,20251122:8-11` - занят 21.11.2025 с 9 до 12 и 22.11.2025 с 8 до 11

### Время начала

Формат: `DD.MM.YYYY HH:MM:SS`

Пример: `29.11.2025 17:39:00`

## Особенности реализации

1. **Расчет нормативов**: Если норматив пустой, берется норматив из шаблона и умножается на количество (по умолчанию 1)

2. **Планирование времени**:
   - Задачи планируются последовательно согласно полю "Предыдущая Задача"
   - Учитываются рабочие часы и обеденный перерыв
   - Задачи ≤4 часов не разделяются между днями

3. **Назначение исполнителей**:
   - Проверяется соответствие параметрам задачи
   - Учитывается занятое время из базы данных
   - Учитываются текущие назначения в рамках планирования
   - Назначается требуемое количество исполнителей (кратное указанному)

4. **Обработка ошибок**:
   - Все ошибки логируются в консоль
   - При критической ошибке отображается сообщение на странице
   - В режиме DEBUG данные не сохраняются в базу данных

## Требования

- Современный браузер с поддержкой ES6+ (async/await, fetch API)
- Наличие элемента `.content` на странице для отображения результатов
- Глобальные переменные `db` и `xsrf` (для работы на реальной странице)

## Лицензия

Этот код создан для решения задачи планирования проектов в системе integram.io.
